<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://vjs.zencdn.net/7.15.4/video-js.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
    <script src="https://vjs.zencdn.net/7.15.4/video.js"></script>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://vjs.zencdn.net">
    <title>HTML Gerado Dinamicamente</title>
</head>

<style>
    .video-js {
        width: 100vw;
        height: 100vh;
        flex: 1;
    }
</style>

<body>
    <video id="my-video" class="video-js" controls autoplay>
        <source id="video-source" type="application/x-mpegURL">
        Seu navegador não suporta o elemento de vídeo.
    </video>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const decryptionKey = '01234567890123456789012345678901';
            var urlAtual = window.location.href;
            var urlObjeto = new URL(urlAtual);
            const encryptedTextpar = urlObjeto.searchParams.get('id');
            const encryptedText = atob(decodeURIComponent(encryptedTextpar));

            async function decryptText(encryptedText, key) {
                try {
                    // Converta a string decodificada para um array de bytes
                    var encryptedBytes = new Uint8Array(encryptedText.length);
                    for (var i = 0; i < encryptedText.length; i++) {
                        encryptedBytes[i] = encryptedText.charCodeAt(i);
                    }

                    // Decrypt usando AES-CBC
                    var decryptedText = CryptoJS.AES.decrypt(
                        { ciphertext: encryptedBytes.subarray(16) },
                        CryptoJS.enc.Utf8.parse(key),
                        {
                            iv: encryptedBytes.subarray(0, 16),
                            mode: CryptoJS.mode.CBC,
                            padding: CryptoJS.pad.Pkcs7
                        }
                    ).toString(CryptoJS.enc.Utf8);

                    return decryptedText;
                } catch (error) {
                    throw new Error("Erro na descriptografia: " + error.message);
                }
            }

            try {
                const decryptedText = await decryptText(encryptedText, decryptionKey);
                console.log(decryptedText);

                var player = videojs('my-video', {
                    techOrder: ['html5', 'flash'],
                    html5: {
                        hls: {
                            enableLowInitialPlaylist: true,
                            smoothQualityChange: true,
                            overrideNative: true,
                            // Aqui você pode adicionar outras configurações do hls.js se necessário
                        },
                    },
                });

                player.src({
                    src: decryptedText,
                    type: 'application/x-mpegURL',
                });

                // Iniciar o player depois de definir a origem
                player.play();
            } catch (error) {
                console.error(error.message);
            }
        });
    </script>
</body>

</html>
